name: CI

on:
  push:
    branches: [ main, meili, develop ]
  pull_request:
    branches: [ main, meili ]
  workflow_dispatch:

env:
  REGISTRY_DOCKERHUB: docker.io
  REGISTRY_GHCR: ghcr.io
  IMAGE_NAME: fs-indexer

jobs:
  # Lint and validate code
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-lint-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-lint-
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort mypy pylint

      - name: Run Black
        run: black --check indexer/ api/

      #- name: Run isort
      #  run: isort --check-only indexer/ api/

      - name: Run Flake8
        run: flake8 indexer/ api/ --max-line-length=120 --extend-ignore=E203,W503,E402

      - name: Run Pylint
        run: |
          pylint indexer/*.py api/*.py --disable=C0111,R0903 || true

      - name: Validate Docker Compose
        run: |
          docker compose config -q
          docker compose -f docker-compose.test.yml config -q

      - name: Validate Dockerfiles
        run: |
          docker run --rm -i hadolint/hadolint < indexer/Dockerfile
          docker run --rm -i hadolint/hadolint < api/Dockerfile
          docker run --rm -i hadolint/hadolint < web/Dockerfile

  # Unit tests for Python components
  test-python:
    name: Test Python Components
    runs-on: ubuntu-latest
    strategy:
      matrix:
        component: [indexer, api]
        python-version: ['3.10', '3.11', '3.12']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.component }}-${{ matrix.python-version }}-${{ hashFiles(format('{0}/requirements*.txt', matrix.component)) }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.component }}-${{ matrix.python-version }}-
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          cd ${{ matrix.component }}
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r tests/requirements-test.txt

      - name: Run unit tests
        run: |
          cd ${{ matrix.component }}
          pytest tests/ -v --cov=. --cov-report=xml --cov-report=term

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: ./${{ matrix.component }}/coverage.xml
          flags: ${{ matrix.component }}
          name: ${{ matrix.component }}-${{ matrix.python-version }}

  # Build Docker images
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [lint, test-python]
    strategy:
      matrix:
        component: [indexer, api, web]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ matrix.component }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-${{ matrix.component }}-
            ${{ runner.os }}-buildx-

      - name: Build image
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.component }}
          file: ./${{ matrix.component }}/Dockerfile
          push: false
          tags: |
            local/${{ env.IMAGE_NAME }}-${{ matrix.component }}:test
            local/${{ env.IMAGE_NAME }}-${{ matrix.component }}:${{ github.sha }}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
          outputs: type=docker,dest=/tmp/${{ matrix.component }}.tar

      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-${{ matrix.component }}
          path: /tmp/${{ matrix.component }}.tar
          retention-days: 1

  # Integration tests
  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download image artifacts
        uses: actions/download-artifact@v5
        with:
          pattern: docker-*
          path: /tmp/images

      - name: Load Docker images
        run: |
          for component in indexer api web; do
            docker load --input /tmp/images/docker-${component}/${component}.tar
          done
          docker images

      - name: Set up test environment
        run: |
          # Create test directories and files
          mkdir -p tests/integration/test_data/sample_files
          echo "test content" > tests/integration/test_data/sample_files/test.txt
          echo "pdf content" > tests/integration/test_data/sample_files/document.pdf
          echo "source code" > tests/integration/test_data/sample_files/code.py
          
          # Create test config
          cp .env.example .env.test
          # Ensure trailing newline before appending to avoid concatenation with last line
          echo "" >> .env.test
          echo "HOST_PATH=$(pwd)/tests/integration/test_data" >> .env.test
          echo "MEILISEARCH_DATA_PATH=/tmp/meilisearch_test" >> .env.test
          
          # Create Meilisearch data directory
          mkdir -p /tmp/meilisearch_test

      - name: Prepare Meilisearch data dir
        run: |
          mkdir -p data/meilisearch
          # ensure it is completely empty (also removes any .gitkeep if present)
          find data/meilisearch -mindepth 1 -delete

      - name: Start services
        run: |
          docker compose -f docker-compose.test.yml up -d
          sleep 10
          docker compose -f docker-compose.test.yml ps
          docker compose -f docker-compose.test.yml logs

      - name: Run integration tests
        run: |
          # Wait for services to be ready
          timeout 240 bash -c 'until curl -sf http://localhost:7700/health; do sleep 2; done'
          timeout 240 bash -c 'until curl -sf http://localhost:8080/health; do sleep 2; done'
          
          # Run indexer
          docker compose -f docker-compose.test.yml run --no-deps --rm indexer
          
          # Test search API
          curl -sf http://localhost:8080/search?q=test | jq .
          curl -sf http://localhost:8080/stats | jq .
          
          # Run Python integration tests
          pip install pytest requests
          pytest tests/integration/test_integration.py -v

      - name: Collect logs on failure
        if: failure()
        run: |
          docker compose -f docker-compose.test.yml logs
          docker compose -f docker-compose.test.yml down

      - name: Clean up
        if: always()
        run: |
          docker compose -f docker-compose.test.yml down -v || true
          # Relax permissions then remove
          sudo chown -R $USER:$USER /tmp/meilisearch_test 2>/dev/null || true
          sudo chmod -R u+rwX /tmp/meilisearch_test 2>/dev/null || true
          sudo rm -rf /tmp/meilisearch_test || true

  # Security scanning
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        component: [indexer, api, web]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download image artifact
        uses: actions/download-artifact@v5
        with:
          name: docker-${{ matrix.component }}
          path: /tmp

      - name: Load Docker image
        run: docker load --input /tmp/${{ matrix.component }}.tar

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: local/${{ env.IMAGE_NAME }}-${{ matrix.component }}:test
          format: 'sarif'
          output: 'trivy-results-${{ matrix.component }}.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results-${{ matrix.component }}.sarif'
          category: 'trivy-${{ matrix.component }}'

  # End-to-end tests
  e2e-test:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: integration-test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download image artifacts
        uses: actions/download-artifact@v5
        with:
          pattern: docker-*
          path: /tmp/images

      - name: Load Docker images
        run: |
          for component in indexer api web; do
            docker load --input /tmp/images/docker-${component}/${component}.tar
          done

      - name: Set up test environment
        run: |
          # Create larger test dataset
          mkdir -p tests/e2e/test_data/{docs,code,media}
          for i in {1..100}; do
            echo "Document $i" > tests/e2e/test_data/docs/doc$i.txt
            echo "Code $i" > tests/e2e/test_data/code/script$i.py
            echo "Media $i" > tests/e2e/test_data/media/image$i.jpg
          done
          
          cp .env.example .env.e2e
          # Ensure newline so appended vars don't merge with final line
          echo "" >> .env.e2e
          echo "HOST_PATH=$(pwd)/tests/e2e/test_data" >> .env.e2e
          echo "MEILISEARCH_DATA_PATH=/tmp/meilisearch_e2e" >> .env.e2e
          mkdir -p /tmp/meilisearch_e2e

      - name: Prepare Meilisearch data dir
        run: |
          mkdir -p data/meilisearch
          # ensure it is completely empty (also removes any .gitkeep if present)
          find data/meilisearch -mindepth 1 -delete

      - name: Start full stack
        run: |
          docker compose --env-file .env.e2e -f docker-compose.test.yml -f docker-compose.e2e.override.yml up -d
          sleep 15
          echo "--- docker compose ps (initial) ---"
          docker compose --env-file .env.e2e -f docker-compose.test.yml -f docker-compose.e2e.override.yml ps
          echo "--- bootstrap logs (initial) ---"
          docker compose --env-file .env.e2e -f docker-compose.test.yml -f docker-compose.e2e.override.yml logs bootstrap || true
          echo "--- meilisearch logs (initial) ---"
          docker compose --env-file .env.e2e -f docker-compose.test.yml -f docker-compose.e2e.override.yml logs meilisearch || true

      - name: Verify bootstrap success before tests
        run: |
          set -e
          CID=$(docker compose --env-file .env.e2e -f docker-compose.test.yml -f docker-compose.e2e.override.yml ps -q bootstrap || true)
          if [ -z "$CID" ]; then
            echo "Bootstrap container ID not found (likely exited quickly). Inferring status via dependent services...";
            # If search-api (which depends on bootstrap success) is up, treat as success
            SA_STATUS=$(docker compose --env-file .env.e2e -f docker-compose.test.yml -f docker-compose.e2e.override.yml ps --format '{{.Service}} {{.Status}}' 2>/dev/null | grep '^search-api ' || true)
            if [ -n "$SA_STATUS" ]; then
              echo "search-api present ($SA_STATUS) -> bootstrap assumed successful";
              exit 0
            fi
            echo "Dependent service not running; dumping compose ps and failing.";
            docker compose --env-file .env.e2e -f docker-compose.test.yml -f docker-compose.e2e.override.yml ps
            exit 1
          fi
          STATUS=$(docker inspect -f '{{.State.Status}}' "$CID")
          EXITCODE=$(docker inspect -f '{{.State.ExitCode}}' "$CID")
          echo "Bootstrap status=$STATUS exitCode=$EXITCODE"
          if [ "$STATUS" = "exited" ] && [ "$EXITCODE" -ne 0 ]; then
            echo "Bootstrap exited with failure. Logs:";
            docker logs "$CID" || true
            docker compose --env-file .env.e2e -f docker-compose.test.yml -f docker-compose.e2e.override.yml logs meilisearch || true
            exit 1
          fi

      - name: Run E2E tests
        run: |
          chmod +x tests/e2e/test_e2e.sh
          ENV_FILE=.env.e2e ./tests/e2e/test_e2e.sh

      - name: Collect service logs on failure (E2E)
        if: failure()
        run: |
          echo "--- Full service logs (failure) ---"
          docker compose --env-file .env.e2e -f docker-compose.test.yml -f docker-compose.e2e.override.yml logs || true

      - name: Clean up
        if: always()
        run: |
          docker compose --env-file .env.e2e -f docker-compose.test.yml -f docker-compose.e2e.override.yml down -v || true
            # Adjust ownership/permissions to allow deletion (Meilisearch may create root-owned 600 files)
          sudo chown -R $USER:$USER /tmp/meilisearch_e2e 2>/dev/null || true
          sudo chmod -R u+rwX /tmp/meilisearch_e2e 2>/dev/null || true
          sudo rm -rf /tmp/meilisearch_e2e tests/e2e/test_data || true
